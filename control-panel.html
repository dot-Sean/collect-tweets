<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Control Panel</title>

        <!-- Bootstrap -->
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/control-panel.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body>
        <h3>Inspect Hash Tag</h3>
        <form class="navbar-form navbar-left" role="search">
            <div class="form-group">
                <input type="text" class="form-control" placeholder="Search" id="hashtag">
            </div>
            <button type="button" id="button" class="btn btn-default">Search</button>
        </form>
        <div style="clear: both"></div>
        <h4 id="results-label" class="hide"></h4>
        <table id="results-table" class="hide">
            <tr>
                <th>Screen Name</th>
                <th>Profile Pic</th>
                <th>User name</th>
                <th>Photo</th>
                <th>Status</th>
                <th>Time</th>
                <th>Hide?</th>
            </tr>
        </table>

        <button type="button" id="button-save" class="btn btn-default hide">Save Button</button>

        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <!--        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>-->
        <script src="jquery/jquery-2.1.1.min.js" type="text/javascript"></script>
        <!-- Include all compiled plugins (below), or include individual files as needed -->
        <script src="js/bootstrap.min.js"></script>
        <script type="text/javascript">
            var button = $("#button");
            var saveButton = $("#button-save");
            var input = $("#hashtag");
            var results_label = $("#results-label");
            var table = document.getElementById("results-table");
            var jtable = $("#results-table");

            saveButton.click(function() {
                for (var i = 1, j = table.rows.length; i < j; i++) {
                    var row = table.rows[i];
                    var cells = row.cells;
                    var screen_name = $(cells[0]).html();
                    var profile_img_url = $("img", $(cells[1])).prop("src");
                    var user_name = $(cells[2]).html();
                    var pic = $("img", $(cells[3]));
                    var pic_url = undefined;
                    if(pic)
                        pic_url = pic.prop("src");                    
                    var status = $("textarea",$(cells[4])).html();
                    var time = $(cells[5]).html();
                    var check = $("input[type=checkbox]",$(cells[6])).is(":checked");
                    var id = $("input[type=hidden]",$(cells[6])).val();
                    var data = {};
                    data["screen_name"] = screen_name;
                    data["profile_img_url"] = profile_img_url;
                    data["user_name"] = user_name;
                    data["pic_url"] = pic_url;
                    data["status"] = status;
                    data["time"] = time;
                    data["check"] = check;
                    data["id"] = id;
                    $.get("save-twitter.php",data);
                }
                saveButton.hide();
            });

            button.click(function() {
                var hashtag = input.val();
                if (hashtag === "")
                    return;

                button.prop('disabled', true);
                input.prop('disabled', true);
                results_label.removeClass("hide");
                jtable.removeClass("hide");
                results_label.text("Searching...");

                clearTableRows(table);

                search(hashtag, -1);

            });
            function search(hashtag, max_id) {
                var url = "twitter.php?tag=" + hashtag;
                if (max_id !== -1)
                    url += "&max_id=" + max_id;

                $.get(url, function(data) {
                    results_label.text("Results");
                    saveButton.removeClass("hide");
                    var new_max_id = insertResultsInTable(data, table,(max_id !== -1));
                    if (new_max_id !== -1)
                        search(hashtag, new_max_id);
                    button.prop('disabled', false);
                    input.prop('disabled', false);

                }, "json")
                        .fail(function() {
                            results_label.text("Something went wrong, do you have internet access? is Twitter working correctly?");
                            button.prop('disabled', false);
                            input.prop('disabled', false);
                        });

            }

            function insertResultsInTable(data, table, startFromOne) {
                var max_id = -1;
                var i = 0;
                if(startFromOne)
                    i = 1;
                for (j = data.length; i < j; i++) {
                    var newRow = table.insertRow(-1);
                    var newCell = newRow.insertCell(newRow.cells.length);
                    newCell.innerHTML = data[i].screen_name;
                    newCell = newRow.insertCell(newRow.cells.length);
                    var img = "<img src='" + data[i].profile_image_url + "'>";
                    newCell.innerHTML = img;
                    newCell = newRow.insertCell(newRow.cells.length);
                    newCell.innerHTML = data[i].user_name;
                    //
                    newCell = newRow.insertCell(newRow.cells.length);
                    newCell.innerHTML = "";
                    if (data[i].original_tweet.entities && data[i].original_tweet.entities.media) {
                        var media = data[i].original_tweet.entities.media;
                        for (var k = 0, l = media.length; k < l; k++) {
                            if (media[k].type.toString().trim() === "photo") {
                                console.log(media[k]);
                                var size = media[k].sizes.small;
                                var photo = "<img width='" + size.w + "' height='" + size.h + "' src='" + media[k].media_url + "'>";
                                newCell.innerHTML = photo;
                            }
                        }
                    }

                    newCell = newRow.insertCell(newRow.cells.length);
                    var ta = "<textarea cols='50'>" + data[i].status + "</textarea>";
                    newCell.innerHTML = ta;

                    newCell = newRow.insertCell(newRow.cells.length);
                    newCell.innerHTML = data[i].time;

                    newCell = newRow.insertCell(newRow.cells.length);
                    var input = "<input type='hidden' value='" + data[i].original_tweet.id + "'>";
                    var check = "<input type='checkbox'>";
                    newCell.innerHTML = check + input;
                    
                    max_id = data[i].original_tweet.id;
                }
                return max_id;
            }
            function clearTableRows(table) {
                var table_rows_count = table.rows.length;
                while (table_rows_count > 1) {
                    table.deleteRow(-1);
                    table_rows_count--;
                }
            }
        </script>
    </body>
</html>